@model DNU.CanteenConnect.Web.Models.Cart

@{
ViewData["Title"] = "Thanh toán Đơn hàng";
decimal cartTotal = 0;
if (Model?.CartItems != null)
{
cartTotal = Model.CartItems.Sum(ci => ci.Quantity * ci.PriceAtAddition);
}
}

<style>
    .checkout-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
    }

    .checkout-container h1 {
        font-size: 2.5rem;
        font-weight: 900;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .checkout-container i {
        font-size: 3rem;
    }

    .payment-method-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .payment-method-card:hover {
        border-color: #667eea;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }

    .payment-method-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    .payment-method-card input[type="radio"]:checked + .method-content {
        color: #667eea;
    }

    .payment-method-card input[type="radio"]:checked ~ .check-icon {
        display: flex;
        animation: slideInCheck 0.3s ease;
    }

    .method-content {
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        padding-right: 50px;
    }

    .method-content i {
        font-size: 2rem;
        color: #667eea;
    }

    .method-text h5 {
        margin: 0;
        font-weight: 700;
        color: #2d3748;
    }

    .method-text p {
        margin: 5px 0 0 0;
        color: #718096;
        font-size: 0.9rem;
    }

    .check-icon {
        display: none;
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        z-index: 10;
    }

    .qr-payment-section {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border: 2px solid #667eea;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        display: none;
        animation: slideUpAnimation 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .qr-payment-section.active {
        display: block;
    }

    .qr-title {
        font-size: 1.8rem;
        font-weight: 900;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .qr-instruction {
        font-size: 1.1rem;
        color: #2d3748;
        margin-bottom: 30px;
    }

    .qr-amount {
        font-size: 2.2rem;
        font-weight: 900;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .qr-code-display {
        background: white;
        border-radius: 16px;
        padding: 30px;
        display: inline-block;
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
        margin: 30px 0;
        border: 3px dashed #667eea;
    }

    .qr-code-display img {
        max-width: 300px;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .bank-info {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
        text-align: left;
    }

    .bank-info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .bank-info-row:last-child {
        border-bottom: none;
    }

    .bank-info-label {
        font-weight: 700;
        color: #2d3748;
    }

    .bank-info-value {
        color: #667eea;
        font-weight: 600;
        font-family: 'Courier New', monospace;
    }

    .checkout-form {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
    }

    .form-section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-label {
        font-weight: 700;
        color: #2d3748;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }

    .form-control,
    .form-select {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 12px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 40px;
        justify-content: center;
    }

    .btn-back {
        background: #e2e8f0;
        color: #2d3748 !important;
        border: none;
        font-weight: 700;
        padding: 14px 32px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: #cbd5e0;
        transform: translateY(-2px);
    }

    .btn-checkout {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white !important;
        border: none;
        font-weight: 700;
        padding: 14px 40px;
        border-radius: 12px;
        font-size: 1.1rem;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .btn-checkout:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
    }

    .btn-checkout:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>

<div class="container-fluid py-5">
    <!-- Hero Header -->
    <div class="checkout-container">
        <h1>
            <i class="fas fa-credit-card"></i>
            Thanh Toán Đơn Hàng
        </h1>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Payment Methods -->
            <div class="checkout-form mb-4">
                <div class="form-section-title">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    Chọn Phương Thức Thanh Toán
                </div>

                <label class="payment-method-card">
                    <input type="radio" name="paymentMethod" value="CashOnDelivery" checked>
                    <div class="method-content">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div class="method-text">
                            <h5>Thanh Toán Khi Nhận Hàng (COD)</h5>
                            <p>Thanh toán trực tiếp khi nhận đơn hàng</p>
                        </div>
                    </div>
                    <div class="check-icon">✓</div>
                </label>

                <label class="payment-method-card">
                    <input type="radio" name="paymentMethod" id="paymentBankTransfer" value="BankTransfer">
                    <div class="method-content">
                        <i class="fas fa-qrcode"></i>
                        <div class="method-text">
                            <h5>Chuyển Khoản Ngân Hàng</h5>
                            <p>Quét mã QR để thanh toán</p>
                        </div>
                    </div>
                    <div class="check-icon">✓</div>
                </label>
            </div>

            <!-- QR Payment Section -->
            <div id="bankTransferDetailsSection" class="qr-payment-section">
                <div class="qr-title">
                    <i class="fas fa-qrcode me-2"></i>Mã QR Chuyển Khoản
                </div>
                <div class="qr-instruction">
                    Vui lòng chuyển khoản số tiền:
                </div>
                <div class="qr-amount" id="finalTotalAmount">
                    @(@Model != null && Model.CartItems != null ? Model.CartItems.Sum(ci => ci.Quantity * ci.PriceAtAddition).ToString("N0") : "0") VNĐ
                </div>

                <div class="qr-code-display">
                    <img id="qrCodeImage" src="https://placehold.co/300x300/667eea/ffffff?text=Đang+tải" alt="Mã QR">
                </div>

                <div class="bank-info">
                    <div class="bank-info-row">
                        <span class="bank-info-label"><i class="fas fa-university me-2"></i>Ngân Hàng:</span>
                        <span class="bank-info-value">MBBank</span>
                    </div>
                    <div class="bank-info-row">
                        <span class="bank-info-label"><i class="fas fa-credit-card me-2"></i>Số Tài Khoản:</span>
                        <span class="bank-info-value">278909999</span>
                    </div>
                    <div class="bank-info-row">
                        <span class="bank-info-label"><i class="fas fa-user me-2"></i>Chủ Tài Khoản:</span>
                        <span class="bank-info-value">NGUYEN VIET QUANG</span>
                    </div>
                    <div class="bank-info-row">
                        <span class="bank-info-label"><i class="fas fa-pen-fancy me-2"></i>Nội Dung:</span>
                        <span class="bank-info-value">DNU CANTEEN - [Tên] - [Tiền]</span>
                    </div>
                </div>
            </div>

            <!-- Order Form -->
            <div class="checkout-form">
                <form id="checkoutForm" asp-controller="Order" asp-action="PlaceOrder" method="post">
                    @Html.AntiForgeryToken()

                    <div class="mb-4">
                        <div class="form-section-title">
                            <i class="fas fa-store me-2"></i>
                            Thông Tin Nhà Ăn
                        </div>
                        <label for="canteenSelect" class="form-label">
                            Chọn Nhà Ăn Nhận Đơn Hàng
                        </label>
                        <select class="form-select" id="canteenSelect" name="selectedCanteenId" required asp-items="ViewBag.Canteens">
                            <option value="">-- Chọn Nhà Ăn --</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <div class="form-section-title">
                            <i class="fas fa-sticky-note me-2"></i>
                            Ghi Chú Đơn Hàng
                        </div>
                        <label for="notes" class="form-label">
                            Ghi Chú Đặc Biệt (Ví Dụ: Không Hành, Thêm Ớt)
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="4" 
                                  placeholder="Nhập ghi chú của bạn tại đây..." maxlength="500"
                                  style="resize: vertical;"></textarea>
                    </div>

                    <div class="button-group">
                        <a asp-controller="Cart" asp-action="Index" class="btn btn-back">
                            <i class="fas fa-arrow-left me-2"></i> Quay Lại Giỏ Hàng
                        </a>
                        <button type="submit" id="confirmOrderBtn" class="btn btn-checkout">
                            <i class="fas fa-check-circle me-2"></i> Xác Nhận Đặt Hàng
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="checkout-form" style="position: sticky; top: 100px;">
                <div class="form-section-title">
                    <i class="fas fa-receipt me-2"></i>
                    Tóm Tắt Đơn Hàng
                </div>

                @if (Model?.CartItems != null && Model.CartItems.Any())
                {
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        @foreach (var item in Model.CartItems)
                        {
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">@item.FoodItem?.Name</div>
                                    <div style="font-size: 0.9rem; color: #718096; margin-bottom: 4px;">Số lượng: x@(item.Quantity)</div>
                                    <div style="font-weight: 700; color: #667eea;">
                                        @((item.Quantity * item.PriceAtAddition).ToString("N0")) VNĐ
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e2e8f0;">

                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #718096;">Tạm Tính:</span>
                        <span style="color: #2d3748; font-weight: 600;">@cartTotal.ToString("N0") VNĐ</span>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <span style="color: #718096;">Phí Vận Chuyển:</span>
                        <span style="color: #2d3748; font-weight: 600;">Miễn Phí</span>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
                                padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 700; color: #2d3748;">Tổng Cộng:</span>
                            <span style="font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                @cartTotal.ToString("N0") VNĐ
                            </span>
                        </div>
                    </div>

                    <div style="background: #f7fafc; border-left: 4px solid #667eea; padding: 12px; border-radius: 8px; font-size: 0.9rem; color: #718096;">
                        <i class="fas fa-info-circle me-2"></i>
                        Vui lòng kiểm tra lại đơn hàng trước khi xác nhận
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">Giỏ hàng trống</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script>
    $(document).ready(function () {
        // Hàm hiện/ẩn QR Code
        function toggleBankTransferDetails() {
            if ($('#paymentBankTransfer').is(':checked')) {
                $('#bankTransferDetailsSection').slideDown();
                generateQrCodeForCheckout(); // Gọi hàm tạo QR
            } else {
                $('#bankTransferDetailsSection').slideUp();
            }
        }

        // Hàm tạo link QR Code (Gọi AJAX hoặc tự tạo link VietQR)
        function generateQrCodeForCheckout() {
            // Lấy tổng số tiền từ thẻ span
            const totalAmountText = $('#finalTotalAmount').text();
            // Loại bỏ " VNĐ", dấu phân cách hàng nghìn và chuyển đổi sang số
            const totalAmountClean = parseFloat(totalAmountText.replace(' VNĐ', '').replace(/\./g, '').replace(',', '.'));

            // Lấy tên người dùng
            const userName = "@(Model != null && Model.User != null && !string.IsNullOrEmpty(Model.User.UserName) ? Model.User.UserName : "Người dùng")";

            // URL đến Action GetQrCodeForCheckout
            const qrCodeServerUrl = `@Url.Action("GetQrCodeForCheckout", "Order", new { totalAmount = 0, userName = "placeholder" })`
                .replace('totalAmount=0', 'totalAmount=' + totalAmountClean)
                .replace('userName=placeholder', 'userName=' + encodeURIComponent(userName));

            // Gán link ảnh vào thẻ img
            $('#qrCodeImage').attr('src', qrCodeServerUrl);
            console.log("Generated Checkout QR Code URL:", qrCodeServerUrl);
        }

        // Chạy khi trang vừa load
        toggleBankTransferDetails();

        // Lắng nghe sự kiện thay đổi radio button
        $('input[name="paymentMethod"]').on('change', function () {
            toggleBankTransferDetails();
        });

        // Xử lý khi bấm nút "Xác nhận Đặt hàng"
        $('#checkoutForm').on('submit', function (e) {
            e.preventDefault(); // Ngăn submit mặc định

            const selectedCanteenId = $('#canteenSelect').val();
            const notes = $('#notes').val();
            const paymentMethod = $('input[name="paymentMethod"]:checked').val();

            // Kiểm tra chọn nhà ăn
            if (!selectedCanteenId || parseInt(selectedCanteenId) <= 0) {
                if (typeof showToast === 'function') {
                    showToast('Vui lòng chọn nhà ăn để nhận đơn hàng.', 'warning');
                }
                $('#confirmOrderBtn').prop('disabled', false).html('<i class="fas fa-check-circle me-2"></i> Xác nhận Đặt hàng');
                return;
            }

            // Disable nút để tránh click nhiều lần
            $('#confirmOrderBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang đặt hàng...');

            // Gửi Ajax
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: {
                    selectedCanteenId: selectedCanteenId,
                    notes: notes,
                    paymentMethod: paymentMethod,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        if (typeof showToast === 'function') {
                            showToast(response.message, 'success');
                        }
                        // Chuyển hướng
                        setTimeout(function() {
                            window.location.href = response.redirectUrl;
                        }, 1500);
                    } else {
                        if (typeof showToast === 'function') {
                            showToast(response.message, 'danger');
                        }
                        if (response.redirectUrl) {
                            setTimeout(function() {
                                window.location.href = response.redirectUrl;
                            }, 1500);
                        } else {
                            $('#confirmOrderBtn').prop('disabled', false).html('<i class="fas fa-check-circle me-2"></i> Xác nhận Đặt hàng');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Lỗi khi đặt hàng:", error);
                    if (typeof showToast === 'function') {
                        showToast('Lỗi khi đặt hàng. Vui lòng thử lại.', 'danger');
                    }
                    $('#confirmOrderBtn').prop('disabled', false).html('<i class="fas fa-check-circle me-2"></i> Xác nhận Đặt hàng');
                }
            });
        });
    });
</script>
}