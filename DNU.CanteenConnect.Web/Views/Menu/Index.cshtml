@model IEnumerable<DNU.CanteenConnect.Web.Models.MenuItemViewModel>
@{
    ViewData["Title"] = "Thực Đơn";
}

<style>
    .menu-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
    }

    .menu-header h1 {
        font-size: 2.5rem;
        font-weight: 900;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .menu-header i {
        font-size: 3rem;
    }

    .filter-card {
        background: white;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        margin-bottom: 40px;
    }

    .filter-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        font-weight: 700;
        color: #2d3748;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        display: block;
    }

    .filter-group input,
    .filter-group select {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 12px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        width: 100%;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }

    .menu-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    @@media (max-width: 1024px) {
        .menu-items-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
    }

    @@media (max-width: 768px) {
        .menu-items-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
    }

    .food-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        border: 2px solid transparent;
        position: relative;
    }

    .food-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.25);
        border-color: #667eea;
    }

    .food-card.sold-out {
        opacity: 0.6;
    }

    .food-card-image {
        width: 100%;
        height: 240px;
        object-fit: cover;
        display: block;
        transition: all 0.3s ease;
    }

    .food-card:hover .food-card-image {
        transform: scale(1.05);
    }

    .sold-out-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        font-weight: 700;
        z-index: 10;
    }

    .food-card-body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .food-card-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .food-card-title a {
        text-decoration: none;
        color: inherit;
        transition: color 0.3s ease;
    }

    .food-card-title a:hover {
        color: #667eea;
    }

    .rating-stars {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }

    .rating-display {
        color: #43e97b;
        font-weight: 600;
    }

    .rating-count {
        color: #718096;
        font-size: 0.85rem;
    }

    .food-card-description {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 16px;
        flex: 1;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .food-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
    }

    .food-card-price {
        font-size: 1.25rem;
        font-weight: 900;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .btn-add-cart {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white !important;
        border: none;
        font-weight: 700;
        padding: 10px 16px;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(67, 233, 123, 0.2);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .btn-add-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(67, 233, 123, 0.3);
    }

    .btn-add-cart:disabled {
        background: #cbd5e0 !important;
        cursor: not-allowed;
        box-shadow: none;
    }

    .empty-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
    }

    .empty-message i {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 20px;
    }

    .empty-message p {
        font-size: 1.1rem;
        color: #718096;
        margin: 0;
    }
</style>

<div class="container-fluid py-5">
    <!-- Menu Header -->
    <div class="menu-header mb-5">
        <h1>
            <i class="fas fa-utensils"></i>
            Thực Đơn Hôm Nay
        </h1>
    </div>

    <!-- Filter Section -->
    <div class="filter-card">
        <div class="filter-title">
            <i class="fas fa-filter"></i>
            Lọc Thực Đơn
        </div>

        <div class="filter-row">
            <div class="filter-group">
                <label for="menuDate">
                    <i class="fas fa-calendar-alt me-2"></i>Chọn Ngày
                </label>
                <input type="date" class="form-control" id="menuDate" value="@ViewBag.SelectedDate.ToString("yyyy-MM-dd")" />
            </div>
            <div class="filter-group">
                <label for="canteenSelect">
                    <i class="fas fa-store me-2"></i>Chọn Nhà Ăn
                </label>
                <select class="form-select" id="canteenSelect" asp-items="ViewBag.CanteenOptions">
                    <option value="">-- Tất Cả --</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Menu Items Grid -->
    <div id="menuItems" class="menu-items-grid">
        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                <div class="food-card @(item.FoodItem.StockQuantity <= 0 ? "sold-out" : "")">
                    @if (item.FoodItem.StockQuantity <= 0)
                    {
                        <div class="sold-out-overlay">
                            <span><i class="fas fa-times-circle me-2"></i> Hết Hàng</span>
                        </div>
                    }
                    <a asp-controller="FoodItems" asp-action="Details" asp-route-id="@item.FoodItem.ItemId" asp-route-returnUrl="/Menu/Index">
                        <img src="@(item.FoodItem.ImageUrl ?? "https://placehold.co/400x250/cccccc/ffffff?text=No+Img")" 
                             class="food-card-image" alt="@item.FoodItem.Name" />
                    </a>

                    <div class="food-card-body">
                        <h5 class="food-card-title">
                            <a asp-controller="FoodItems" asp-action="Details" asp-route-id="@item.FoodItem.ItemId" 
                               asp-route-returnUrl="/Menu/Index">
                                @item.FoodItem.Name
                            </a>
                        </h5>

                        <div class="rating-stars">
                            @if (item.ReviewCount > 0)
                            {
                                <span class="rating-display">⭐ @item.AverageRating.ToString("F1")</span>
                                <span class="rating-count">(@item.ReviewCount đánh giá)</span>
                            }
                            else
                            {
                                <span class="rating-count"><i class="fas fa-star-half-alt"></i> Chưa có đánh giá</span>
                            }
                        </div>

                        <p class="food-card-description">@(item.FoodItem.Description ?? "Không có mô tả")</p>

                        <div class="food-card-footer">
                            <span class="food-card-price">@item.FoodItem.Price.ToString("N0") VNĐ</span>
                            <button type="button" class="btn-add-cart add-to-cart-btn"
                                    data-item-id="@item.FoodItem.ItemId"
                                    data-item-name="@item.FoodItem.Name"
                                    data-item-price="@item.FoodItem.Price"
                                    @(item.FoodItem.StockQuantity <= 0 ? "disabled" : "")>
                                <i class="fas fa-cart-plus me-1"></i> Thêm
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-message">
                <i class="fas fa-inbox"></i>
                <p>Chưa có món ăn nào có sẵn để hiển thị</p>
            </div>
        }
    </div>
</div>

<form id="antiForgeryForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        function renderFractionalStars(rating, count) {
            if (count > 0) {
                const formattedRating = parseFloat(rating).toFixed(1);
                return `<span class="rating-display">⭐ ${formattedRating}</span><span class="rating-count">(${count} đánh giá)</span>`;
            } else {
                return '<span class="rating-count"><i class="fas fa-star-half-alt"></i> Chưa có đánh giá</span>';
            }
        }

        $(document).ready(function () {
            $('#menuDate, #canteenSelect').on('change', function () {
                const date = $('#menuDate').val();
                const canteenId = $('#canteenSelect').val();

                $.get('/Menu/DailyMenuItems', { menuDate: date, canteenId: canteenId }, function (data) {
                    renderMenuItems(data);
                }).fail(function () {
                    console.error("Lỗi khi lọc thực đơn");
                });
            });

            function renderMenuItems(items) {
                const menuItemsContainer = $('#menuItems');
                menuItemsContainer.empty();

                if (items && items.length > 0) {
                    items.forEach(item => {
                        const isSoldOut = item.stockQuantity <= 0;
                        const soldOutClass = isSoldOut ? "sold-out" : "";
                        const soldOutOverlay = isSoldOut ? `<div class="sold-out-overlay"><span><i class="fas fa-times-circle me-2"></i> Hết Hàng</span></div>` : "";
                        const disabledAttr = isSoldOut ? "disabled" : "";
                        const ratingHtml = renderFractionalStars(item.averageRating, item.reviewCount);
                        
                        const itemHtml = `
                            <div class="food-card ${soldOutClass}">
                                ${soldOutOverlay}
                                <a href="/FoodItems/Details/${item.itemId}?returnUrl=/Menu/Index">
                                    <img src="${item.imageUrl || 'https://placehold.co/400x250/cccccc/ffffff?text=No+Img'}" 
                                         class="food-card-image" alt="${item.name}" />
                                </a>
                                <div class="food-card-body">
                                    <h5 class="food-card-title">
                                        <a href="/FoodItems/Details/${item.itemId}?returnUrl=/Menu/Index">${item.name}</a>
                                    </h5>
                                    <div class="rating-stars">
                                        ${ratingHtml}
                                    </div>
                                    <p class="food-card-description">${item.description || 'Không có mô tả'}</p>
                                    <div class="food-card-footer">
                                        <span class="food-card-price">${item.price.toLocaleString('vi-VN')} VNĐ</span>
                                        <button type="button" class="btn-add-cart add-to-cart-btn"
                                                data-item-id="${item.itemId}" data-item-name="${item.name}" data-item-price="${item.price}" ${disabledAttr}>
                                            <i class="fas fa-cart-plus me-1"></i> Thêm
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                        menuItemsContainer.append(itemHtml);
                    });
                } else {
                    menuItemsContainer.append('<div class="empty-message"><i class="fas fa-inbox"></i><p>Chưa có món ăn nào phù hợp</p></div>');
                }
            }

            $('#menuItems').on('click', '.add-to-cart-btn', function () {
                const foodItemId = $(this).data('item-id');
                const antiForgeryToken = $('#antiForgeryForm input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '/Cart/AddToCart',
                    type: 'POST',
                    data: {
                        itemId: foodItemId,
                        quantity: 1,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function (response) {
                        if (response.success) {
                            showToast(response.message, 'success');
                            if (typeof updateNavbarCartCount === 'function') {
                                updateNavbarCartCount();
                            }
                            $(window).trigger('cartUpdated');
                        } else {
                            showToast(response.message, 'danger');
                        }
                    },
                    error: function () {
                        showToast('Lỗi khi thêm vào giỏ hàng. Vui lòng thử lại.', 'danger');
                    }
                });
            });
        });
    </script>
}
